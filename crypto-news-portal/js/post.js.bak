// post.js - Handles loading and displaying individual blog posts using iframe

// Function to get URL parameter
function getUrlParameter(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    var results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
}

// Function to load the article content
function loadArticle() {
    const articleUrl = getUrlParameter('url');
    
    if (!articleUrl) {
        document.querySelector('#article-title').textContent = 'Error: No article URL provided.';
        document.querySelector('#article-iframe').style.display = 'none';
        return;
    }

    try {
        // Set the iframe source to the proxy endpoint to bypass X-Frame-Options
        const iframe = document.querySelector('#article-iframe');
        iframe.src = `/api/proxy-content?url=${encodeURIComponent(articleUrl)}`;
        
        // Update page title
        document.title = 'CryptoDaily - Article';
        
        // Fetch article details to show the actual blog title
        fetch(`/api/article?url=${encodeURIComponent(articleUrl)}`)
            .then(response => response.json())
            .then(article => {
                document.querySelector('#article-title').textContent = article.title || 'Article';
                document.querySelector('#article-date').textContent = article.pubDate || new Date().toLocaleDateString();
                document.querySelector('#article-source').textContent = `Source: ${article.source || articleUrl.replace(/^https?:\/\//, '').split('/')[0]}`;
                
                // Fetch and display related posts based on the current article
                fetchRelatedPosts(articleUrl, article.title);
                
                // Fetch and display view count
                fetchViewCount(articleUrl);
            })
            .catch(error => {
                console.error('Error fetching article details:', error);
                // Fallback to showing a generic title
                document.querySelector('#article-title').textContent = 'Article';
                document.querySelector('#article-date').textContent = new Date().toLocaleDateString();
                document.querySelector('#article-source').textContent = '';
                
                // Still try to fetch related posts based on URL
                fetchRelatedPosts(articleUrl);
                
                // Still try to fetch view count
                fetchViewCount(articleUrl);
            });
        
    } catch (error) {
        console.error('Error loading article:', error);
        document.querySelector('#article-title').textContent = 'Error loading article.';
        document.querySelector('#article-iframe').style.display = 'none';
    }
}

// Function to fetch and display related posts
function fetchRelatedPosts(currentUrl, articleTitle = null) {
    // Try to determine a category from the article title if available
    let category = null;
    if (articleTitle) {
        const lowerTitle = articleTitle.toLowerCase();
        if (lowerTitle.includes('bitcoin') || lowerTitle.includes('btc')) {
            category = 'bitcoin';
        } else if (lowerTitle.includes('ethereum') || lowerTitle.includes('eth')) {
            category = 'ethereum';
        } else if (lowerTitle.includes('defi')) {
            category = 'defi';
        } else if (lowerTitle.includes('nft') || lowerTitle.includes('nfts')) {
            category = 'nfts';
        } else if (lowerTitle.includes('altcoin') || lowerTitle.includes('altcoins')) {
            category = 'altcoins';
        } else if (lowerTitle.includes('regulation') || lowerTitle.includes('regulatory')) {
            category = 'regulation';
        }
    }
    
    
    // Show loading indicator
function fetchViewCount(articleUrl) {
    fetch(`/api/view-count?url=${encodeURIComponent(articleUrl)}`)
        .then(response => response.json())
        .then(data => {
            const viewCountElement = document.querySelector('#view-count-value');
            if (data.count) {
                // Format the number with K if it's over 1000
                let formattedCount;
                if (data.count >= 1000) {
                    formattedCount = (data.count / 1000).toFixed(1) + 'K';
                } else {
                    formattedCount = data.count;
                }
                viewCountElement.textContent = `${formattedCount} views`;
            } else {
                viewCountElement.textContent = 'View count unavailable';
            }
        })
        .catch(error => {
            console.error('Error fetching view count:', error);
            document.querySelector('#view-count-value').textContent = 'View count unavailable';
        });
}

// Initialize comment functionality
document.addEventListener('DOMContentLoaded', function() {
    // Add event listener to the comment button
    const commentBtn = document.getElementById('add-comment-btn');
    const commentInput = document.getElementById('comment-input');
    
    if (commentBtn && commentInput) {
        commentBtn.addEventListener('click', addComment);
        
        // Also allow adding comment with Enter key (while holding Shift)
        commentInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.shiftKey) {
                e.preventDefault(); // Prevent new line
                addComment();
            } else if (e.key === 'Enter' && !e.shiftKey) {
                // Allow new line if Shift is not pressed
                return true;
            }
        });
    }
    
    // Load existing comments
    loadComments();
});

// Function to add a new comment
function addComment() {
    const commentInput = document.getElementById('comment-input');
    const commentText = commentInput.value.trim();
    
    if (commentText === '') {
        alert('Please enter a comment');
        return;
    }
    
    // Create a new comment object
    const newComment = {
        id: Date.now(), // Simple ID based on timestamp
        text: commentText,
        author: 'Anonymous',
        date: new Date().toLocaleString(),
        avatar: 'https://ui-avatars.com/api/?name=Anonymous&background=3a86ff&color=fff'
    };
    
    // Add to local storage
    saveComment(newComment);
    
    // Add to the page
    displayComment(newComment);
    
    // Clear the input
    commentInput.value = '';
}

// Function to save comment to localStorage
function saveComment(comment) {
    const comments = getComments();
    comments.unshift(comment); // Add to beginning of array
    localStorage.setItem('post-comments', JSON.stringify(comments));
}

// Function to retrieve comments from localStorage
function getComments() {
    const commentsStr = localStorage.getItem('post-comments');
    if (commentsStr) {
        return JSON.parse(commentsStr);
    }
    return [];
}

// Function to load and display comments
function loadComments() {
    const comments = getComments();
    const commentList = document.getElementById('comment-list');
    
    if (comments.length === 0) {
        commentList.innerHTML = '<p>No comments yet. Be the first to comment!</p>';
        return;
    }
    
    commentList.innerHTML = '';
    comments.forEach(comment => {
        displayComment(comment);
    });
}

// Function to display a single comment
function displayComment(comment) {
    const commentList = document.getElementById('comment-list');
    
    // If showing "No comments" message, clear it
    if (commentList.innerHTML.includes('No comments yet')) {
        commentList.innerHTML = '';
    }
    
    const commentElement = document.createElement('div');
    commentElement.className = 'comment-item';
    commentElement.innerHTML = `
        <div class="comment-author">${comment.author}</div>
        <div class="comment-date">${comment.date}</div>
        <div class="comment-text">${comment.text}</div>
    `;
    
    // Add to the top of the list
    if (commentList.firstChild) {
        commentList.insertBefore(commentElement, commentList.firstChild);
    } else {
        commentList.appendChild(commentElement);
    }
}

// Function to display related posts in the sidebar
function displayRelatedPosts(posts) {
    const container = document.querySelector('#related-posts');
    
    if (!posts || posts.length === 0) {
        container.innerHTML = '<p>No related posts found.</p>';
        return;
    }
    
    let html = '';
    posts.forEach(post => {
        const pubDate = new Date(post.pubDate).toLocaleDateString();
        html += `
            <div class="related-post-item">
                <h4 onclick="window.location.href='post.html?url=${encodeURIComponent(post.link)}'">${post.title}</h4>
                <img src="${post.image}" alt="${post.title}" class="related-post-thumbnail" onclick="window.location.href='post.html?url=${encodeURIComponent(post.link)}'">
                <div class="meta">
                    <span>${pubDate}</span>
                </div>
                <a href="post.html?url=${encodeURIComponent(post.link)}">Read More</a>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Load the article when the page loads
document.addEventListener('DOMContentLoaded', function() {
    loadArticle();
});}
