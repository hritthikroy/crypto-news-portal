// RSS Feed Integration Script

// Function to fetch news from backend API
async function fetchNewsFromAPI() {
    try {
        const response = await fetch('/api/news');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const newsItems = await response.json();
        return newsItems;
    } catch (error) {
        console.error('Error fetching news from API:', error);
        // Return sample data in case of error
        return [
            {
                title: "Bitcoin Reaches New All-Time High as Institutional Adoption Grows",
                description: "Major corporations and investment firms are increasingly adding Bitcoin to their treasury reserves, driving unprecedented demand and pushing prices to new records.",
                link: "#",
                pubDate: new Date().toLocaleDateString(),
                source: "CryptoNews",
                image: "https://via.placeholder.com/300x169?text=Bitcoin+News"
            },
            {
                title: "Ethereum 2.0 Upgrade Progress Continues as Staking Rewards Increase",
                description: "The latest Ethereum 2.0 implementation has seen a significant increase in staking participation, with rewards reaching new levels as the network prepares for full transition.",
                link: "#",
                pubDate: new Date(Date.now() - 86400000).toLocaleDateString(), // Yesterday
                source: "CryptoNews",
                image: "https://via.placeholder.com/300x169?text=Ethereum+News"
            },
            {
                title: "New DeFi Protocol Revolutionizes Yield Farming with Innovative Algorithm",
                description: "A breakthrough in decentralized finance has emerged with a new protocol that promises higher yields with lower risk than traditional farming methods.",
                link: "#",
                pubDate: new Date(Date.now() - 172800000).toLocaleDateString(), // 2 days ago
                source: "CryptoNews",
                image: "https://via.placeholder.com/300x169?text=DeFi+News"
            },
            {
                title: "Central Banks Explore Digital Currencies Amid Growing Crypto Adoption",
                description: "Multiple central banks worldwide are advancing their own digital currency projects as cryptocurrency adoption continues to grow in the private sector.",
                link: "#",
                pubDate: new Date(Date.now() - 259200000).toLocaleDateString(), // 3 days ago
                source: "CryptoNews",
                image: "https://via.placeholder.com/300x169?text=Digital+Currencies"
            },
            {
                title: "Regulatory Clarity Expected Soon as Government Working Groups Convene",
                description: "Government agencies are working together to establish clearer regulations for the cryptocurrency industry, with several new frameworks expected to be announced in the coming weeks.",
                link: "#",
                pubDate: new Date(Date.now() - 345600000).toLocaleDateString(), // 4 days ago
                source: "CryptoNews",
                image: "https://via.placeholder.com/300x169?text=Regulatory+News"
            }
        ];
    }
}

// Variables to track pagination and data
let allNewsItems = [];
let popularNewsItems = [];
let displayedItems = 9; // Show 9 items initially as requested
let currentItems = 0;

// Function to fetch popular news
async function fetchPopularNews() {
    try {
        const response = await fetch('/api/popular');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const newsItems = await response.json();
        return newsItems;
    } catch (error) {
        console.error('Error fetching popular news from API:', error);
        // Return sample data in case of error
        return [
            {
                title: "Most Popular: Bitcoin Reaches New All-Time High",
                description: "Major corporations and investment firms are increasingly adding Bitcoin to their treasury reserves.",
                link: "#",
                pubDate: new Date().toLocaleDateString(),
                source: "CryptoNews",
                image: "https://via.placeholder.com/300x169?text=Popular+News"
            },
            {
                title: "Ethereum 2.0 Upgrade Creates Buzz",
                description: "The latest Ethereum 2.0 implementation has seen significant increases in staking participation.",
                link: "#",
                pubDate: new Date(Date.now() - 86400000).toLocaleDateString(),
                source: "CryptoNews",
                image: "https://via.placeholder.com/300x169?text=Popular+News"
            }
        ];
    }
}

// Function to display popular news with scrolling
function displayPopularNews(newsItems) {
    // Wait for the DOM to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const container = document.getElementById('popular-news-container');
                if (container) {
                    renderPopularNews(container, newsItems);
                }
            }, 100);
        });
    } else {
        // DOM is already loaded
        setTimeout(() => {
            const container = document.getElementById('popular-news-container');
            if (container) {
                renderPopularNews(container, newsItems);
            }
        }, 100);
    }
}

// Helper function to render popular news
function renderPopularNews(container, newsItems) {
    if (!newsItems || newsItems.length === 0) {
        container.innerHTML = '<div class="no-popular-news">No popular news available at this time.</div>';
        return;
    }

    // Clear any loading text
    container.innerHTML = '';

    // Create a scrolling container for popular news
    let scrollingContainer = document.createElement('div');
    scrollingContainer.className = 'popular-news-scrolling';

    // Add only first 8 popular news items
    const topPopularItems = newsItems.slice(0, 8);

            // Add each popular news item to the scrolling container
    const validItems = topPopularItems.filter(item => item.image && item.image !== '' && item.image.trim() !== '');
    
    // Function to create a popular news item element with short heading
    const createPopularItem = (item) => {
        // Create a short title by truncating if too long
        let shortTitle = item.title;
        if (shortTitle.length > 50) {
            shortTitle = shortTitle.substring(0, 47) + '...';
        }
        
        const popularItem = document.createElement('div');
        popularItem.className = 'popular-news-item';

        // Show only short headline without reference and time
        popularItem.innerHTML = `
            <div class="popular-news-content">
                <h4 data-link="${item.link}">${shortTitle}</h4>
            </div>
        `;

        // Add click event to the entire item to open the article
        popularItem.addEventListener('click', function() {
            window.open(item.link, '_blank');
        });

        // Add click event to the title to open the article
        const titleElement = popularItem.querySelector('h4');
        if (titleElement) {
            titleElement.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent triggering the parent click event
                window.open(this.getAttribute('data-link'), '_blank');
            });
        }
        
        return popularItem;
    };
    
    // Add original items to the scrolling container
    validItems.forEach(item => {
        scrollingContainer.appendChild(createPopularItem(item));
    });
    
    // Add duplicate items to create seamless loop effect
    validItems.forEach(item => {
        scrollingContainer.appendChild(createPopularItem(item));
    });

    container.appendChild(scrollingContainer);
}

// Function to display news items
function displayNewsItems(newsItems) {
    // Filter out items without images first
    allNewsItems = newsItems.filter(item => item.image && item.image !== '' && item.image.trim() !== '');
    currentItems = 0;

    const container = document.getElementById('rss-feed-content');

    // Clear loading message
    container.innerHTML = '<h2>Latest Crypto News</h2>';

    if (allNewsItems.length === 0) {
        container.innerHTML += '<p>No news with images available at this time.</p>';
        return;
    }

    // Show initial 9 news items as requested
    showNextItems();
}

// Function to show next set of news items
function showNextItems() {
    const container = document.getElementById('rss-feed-content');

    // Create news grid if it doesn't exist
    let newsGrid = container.querySelector('.news-grid-container');
    if (!newsGrid) {
        newsGrid = document.createElement('div');
        newsGrid.className = 'news-grid-container';
        container.appendChild(newsGrid);
    }

    // Add next set of news items with thumbnails
    let itemsAdded = 0;
    let index = currentItems;
    
    while (itemsAdded < displayedItems && index < allNewsItems.length) {
        const item = allNewsItems[index];
        
        // Only add items that have valid images/thumbnails (not empty)
        if (item.image && item.image !== '' && item.image.trim() !== '') {
            const newsElement = document.createElement('div');
            newsElement.className = 'news-item';
            newsElement.innerHTML = `
                <h3 class="news-title" data-link="${item.link}">${item.title}</h3>
                <div class="meta">
                    <span>${item.pubDate}</span>
                    <span>Source: ${item.source}</span>
                </div>
                ${item.image ? `<img src="${item.image}" alt="${item.title}" class="news-image">` : ''}
                <p>${item.description}</p>
                <a href="${item.link}" target="_blank">Read Full Article</a>
            `;

            // Add click event to the title to open the article
            const titleElement = newsElement.querySelector('.news-title');
            titleElement.addEventListener('click', function() {
                window.open(this.getAttribute('data-link'), '_blank');
            });

            newsGrid.appendChild(newsElement);
            itemsAdded++;
            
            // Add an ad after every 6 posts
            if (itemsAdded % 6 === 0 && itemsAdded < displayedItems) {
                const adElement = document.createElement('div');
                adElement.className = 'news-ad';
                adElement.innerHTML = `
                    <div class="ad-placeholder">
                        <ins class="adsbygoogle"
                             style="display:block"
                             data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
                             data-ad-slot="1234567893"
                             data-ad-format="auto"
                             data-full-width-responsive="true"></ins>
                        <script>
                             (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                    </div>
                `;
                newsGrid.appendChild(adElement);
            }
        }
        
        index++;
    }

    currentItems = index;

    // Show or hide the "Load More" button based on remaining items
    const loadMoreButton = container.querySelector('#load-more-btn');
    if (!loadMoreButton && currentItems < allNewsItems.length) {
        createLoadMoreButton(container);
    } else if (loadMoreButton) {
        if (currentItems >= allNewsItems.length) {
            loadMoreButton.style.display = 'none';
        } else {
            loadMoreButton.style.display = 'block';
        }
    }
}

// Function to create the "Load More" button
function createLoadMoreButton(container) {
    const loadMoreButton = document.createElement('button');
    loadMoreButton.id = 'load-more-btn';
    loadMoreButton.className = 'load-more-btn';
    loadMoreButton.textContent = 'Load More News';
    loadMoreButton.addEventListener('click', showNextItems);
    container.appendChild(loadMoreButton);
}

// Update the loadNews function to fetch both popular and regular news
async function loadNews() {
    try {
        // Fetch both popular and regular news
        const [popularNews, regularNews] = await Promise.all([
            fetchPopularNews(),
            fetchNewsFromAPI()
        ]);

        popularNewsItems = popularNews;
        displayPopularNews(popularNews);
        displayNewsItems(regularNews);
    } catch (error) {
        console.error('Error in loadNews:', error);
        // Fallback: still load regular news even if popular news fails
        const regularNews = await fetchNewsFromAPI();
        displayNewsItems(regularNews);
        // Still try to display popular news with a fallback
        displayPopularNews([]);
    }
}

// Load news when page loads
document.addEventListener('DOMContentLoaded', () => {
    loadNews();
});

// Optional: Reload news every 10 minutes
setInterval(() => {
    loadNews();
}, 10 * 60 * 1000); // 10 minutes